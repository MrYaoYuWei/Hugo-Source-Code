---
title: "Nmap高级使用"
date: 2020-02-16T20:22:59+08:00
categories: ['Kali']
tags: ['安全渗透']
---

nmap高级使用技巧

<!--more-->

## nmap高级使用技巧

* nmap概述

> nmap是一个网络探测和安全扫描程序，系统管理者和个人可以使用这个软件扫描大型的网络，获取 那台主机正在运行以及提供什么服务等信息。nmap支持徆多扫描技术，例如：UDP、TCP connect()、 TCP SYN(半开扫描)、ftp代理(bounce攻击)、反向标志、ICMP、FIN、ACK扫描、圣诞树(Xmas Tree)、 SYN扫描和null扫描。还可以探测操作系统类型。 

* nmap主要功能概述 nmap [Scan Type(s)] [Options] 

  >主机发现
  >
  >端口探测
  >
  >版本探测
  >
  >系统探测
  >
  >防火墙/IDS规避
  >
  >NSE脚本引擎

* 主机发现 

  >主机发现发现的原理与Ping命令类似，发送探测包到目标主机，如果收到回复，那么说明目标主机是开启的。
  >
  >发送ICMP ECHO/TIMESTAMP/NETMASK报文、发送TCPSYN/ACK包、发送SCTP INIT/COOKIE-ECHO包，用户可以在不同的条件下灵活选用不同的方式来探测目标机。
  >
  >通常主机发现并不单独使用，而只是作为端口扫描、版本侦测、OS侦测先行步骤。而在某些特殊应用（例如确定大型局域网内活动主机的数量），可能会单独专门适用主机发现功能来完成

  > [Scan Type(s)]
  >
  >-sL  将指定的目标的IP列举出来，不进行主机发现
  >
  >-sn  Ping Scan 只进行主机发现，不进行端口扫描 。通过ARP包来询问IP地址上的主机是否活动的，如果收到ARP回复包，那么说明主机在线
  >
  >-Pn 将所有指定的主机视作开启的，跳过主机发现的过程( 如果已经确知目标主机已经开启，可用该选项）
  >
  >-PS  使用TCP/SYN方式进行发现 
  >
  >-PA 使用TCP/ACK方式进行发现
  >
  >-PU 使用UDP请求包发现主机
  >
  >-PE 使用ICMP echo请求包发现主机
  >
  >-PO 使用IP协议包探测对方主机是否开启

>[Options] 
>
>-n 不进行DNS解析
>
>-R 进行DNS解析
>
>--dns-servers <serv1[,serv2],...> 指定DNS服务器
>
>--system-dns 指定使用系统的DNS服务器
>
>--traceroute 追踪每个路由节点

* 端口探测

  >用于确定目标主机的TCP/UDP端口的开放情况
  >
  >默认情况下，Nmap会扫描1000个最有可能开放的TCP端口

> 端口的6个状态
>
> open：端口是开放的
>
> closed：端口是关闭的
>
> filtered：端口被防火墙IDS/IPS屏蔽，无法确定其状态
>
> unfiltered：端口没有被屏蔽，但是否开放需要进一步确定
>
> open|filtered：端口是开放的或被屏蔽
>
> closed|filtered ：端口是关闭的或被屏蔽

> [Scan Type(s)]
>
>-sS Nmap默认的扫描方式，发送SYN到目标端口，如果收到SYN/ACK回复，那么判断端口是开放的(open)；如果收到RST包，说明该端口是关闭的(closed)。如果没有收到回复，那么判断该端口被屏蔽（filtered）该方式仅发送SYN包对目标主机的特定端口，但不建立的完整的TCP连接，所以相对比较隐蔽，而且效率比较高，适用范围广
>
>-sT TCP connect方式使用系统网络API connect向目标主机的端口发起连接，如果无法连接，说明该端口关闭(closed)。该方式扫描速度比较慢，而且由于建立完整的TCP连接会在目标机上留下记录信息，不够隐蔽
>
>-sA 向目标主机的端口发送ACK包，如果收到RST包，说明该端口没有被防火墙屏蔽；没有收到RST包，说明被屏蔽。该方式只能用于确定防火墙是否屏蔽某个端口，可以辅助TCP SYN的方式来判断目标主机防火墙的状况
>
>-sF/-sX/-sN FIN扫描向目标主机的端口发送的TCP FIN包或Xmas tree包/Null包，如果收到对方RST回复包，那么说明该端口是关闭的(closed)；没有收到RST包说明端口可能是开放的(open)或被屏蔽的(filtered )
>
>-sU 向目标主机的UDP端口发送探测包，如果收到回复“ICMP port unreachable”就说明该端口是关闭的(close)；如果没有收到回复，那说明UDP端口可能是开放的或屏蔽的(open|filtered )
>
>-sI 使用idle scan方式来扫描目标主机，前提需要找到合适的zombie host 
>
>-sO 使用IP protocol 扫描确定目标机支持的协议类型
>
>You specified more than one type of TCP scan.  Please choose only one of -sA, -b, -sT, -sF, -sI, -sM, -sN, -sS, -sW, and -sX 只能任选一个功能参数

> [Options]
>
> -p 指定扫描的端口 -p1-65535;如 -p U:53,111,137,T:21-25,80,139,8080,S:9  T代表TCP协议、U代表UDP协议、S代表SCTP协议
>
> -F Fast mode 快速模式，仅扫描TOP 100的端口 
>
> -r 不进行端口随机打乱的操作 ，如无该参数，nmap会将要扫描的端口以随机顺序方式扫描，以让nmap的扫描不易被对方防火墙检测到
>
> --top-ports 300 扫描最有可能开放的300个端口（TCP和UDP分别有300个端口）
>
> -T4 时间级别配置4级
>
> 补充实用参数
>
> --randomize_hosts  主机随机扫描不易被目标机发现
>
>  --scan-delay  延时扫描，单位秒 不易被目标机发现
>
> 补充实用:
>
> 查看端口正在被哪个进程使用
>
> lsof -i :22
>
> grep -aux | grep sshd  kill -9 xxxx(进程号)
>
> which sshd  rm -rf xxx/xxx/xxx  执行脚本文件若无则是木马脚本

* 版本侦测

  > 版本侦测，用于确定目标主机开放端口上运行的具体的应用程序及版本信息
  >
  > 支持TCP/UDP协议，支持文本格式与二进制格式
  >
  > 广泛的应用程序数据库（nmap-services-probes）。目前Nmap可以识别几千种服务的签名，包含了180多种不同的协议

> 版本侦测原理
>
> 首先检查open与open|filtered状态的端口是否在排除端口列表内。如果在排除列表，将该端口剔除
>
> 如果是TCP端口，尝试建立TCP连接。通常在等待时间内，会接收到目标机发送的“WelcomeBanner”信息，nmap将接收到的Banner与nmap-services-probes中NULL probe中的签名进行对比，查找对应应用程序的名字与版本信息
>
> 如果通过“Welcome Banner”无法确定应用程序版本，那么nmap再尝试发送其他的探测包，将probe得到回复包与数据库中的签名进行对比，如果反复探测都无法得出具体应用，那么打印出应用返回报文，让用户自行进一步判定
>
> 如果是UDP端口，那么直接使用nmap-services-probes中探测包进行探测匹配。根据结果对比分析出UDP应用服务类型
>
> 如果探测到应用程序是SSL，那么调用openSSL进一步的侦查运行在SSL之上的具体的应用类型
>
> 如果探测到应用程序是SunRPC，那么调用brute-force RPC grinder进一步探测具体服务

> [Options]
>
> -sV 指定让Nmap进行版本侦测 
>
> --version-intensity  指定版本侦测强度（0-9），默认为7
>
> --version-light 指定使用轻量侦测方式 (intensity 2) 
>
> --version-all 尝试使用所有的probes进行侦测 (intensity 9) 
>
> --version-trace 显示出详细的版本侦测过程信息

* 操作系统侦测

> 操作系统侦测用于检测目标主机运行的操作系统类型及设备类型等信息
>
> Nmap拥有丰富的系统数据库nmap-os-db，目前可以识别2600多种操作系统与设备类型

> 操作系统侦测原理
>
> Nmap内部包含了2600多已知系统的指纹特征（在文件nmap-os-db文件中）。将此指纹数据库作为进行指纹对比的样本库
>
> 分别挑选一个open和closed的端口，向其发送经过精心设计的TCP/UDP/ICMP数据包，根据返回的数据包生成一份系统指纹
>
> 将探测生成的指纹与nmap-os-db中指纹进行对比，查找匹配的系统。如果无法匹配，以概率形式列举出可能的系统

> [Options]
>
> -O 指定Nmap进行OS侦测
>
> --osscan-limit  限制Nmap只对确定的主机的进行OS探测（至少需确知该主机分别有一个open和closed的端口）
>
> --osscan-guess 大胆猜测对方的主机的系统类型。由此准确性会下降不少，但会尽可能多为用户提供潜在的操作系统

* 规避防火墙/IDS（入侵监测系统）

> 防火墙与IDS规避为用于绕开防火墙与IDS（入侵检测系统）的检测与屏蔽，以便能够更加详细地发现目标主机的状况
>
> 分片 将可疑的探测包进行分片处理（例如将TCP包拆分成多个IP包发送过去），某些简单的防火墙为了加快处理速度可能不会进行重组检查，以此避开其检查 -f  
>
> IP 诱骗  在进行扫描时，将真实IP地址和其他主机的IP地址（其他主机需要在线，否则目标主机将回复大量数据包到不存在的主机，从而实质构成了拒绝服务攻击）混合使用，以此让目标主机的防火墙或IDS追踪检查大量的不同IP地址的数据包，降低其追查到自身的概率。注意，某些高级的IDS系统通过统计分析仍然可以追踪出扫描者真实IP地址 <decoy1,decoy2[,ME],...>
>
> IP 伪装 IP伪装即将自己发送的数据包中的IP地址伪装成其他主机的地址，从而目标机认为是其他主机在与之通信。需要注意，如果希望接收到目标主机的回复包，那么伪装的IP需要位于统一局域网内 如果既希望隐蔽自己的IP地址，又希望收到目标主机的回复包，那么可以尝试使用idle scan  -S
>
> 指定源端口 某些目标主机只允许来自特定端口的数据包通过防火墙。例如FTP服务器配置为：允许源端口为21号的TCP包通过防火墙与FTP服务端通信，但是源端口为其他端口的数据包被屏蔽。所以，在此类情况下，可以指定Nmap将发送的数据包的源端口都设置特定的端口  -g --source-port
>
> 指定使用某个网络接口来发送数据包 -e
>
> 指定TTL --ttl
>
> 扫描延时
>
> 指定发送包的最小长度 --data-length
>
> 指定发包的MTU --mtu
>
> 指定伪装的MAC地址 --spoof-mac
>
> 使用错误检查和 --badsum 正常情况下，该类数据包被抛弃，如果收到回复，说明回复来自防火墙或IDS/IPS

* NSE脚本引擎

> NSE脚本引擎（Nmap Scripting Engine）是Nmap最强大最灵活的功能之一，允许用户自己编写脚本来执行自动化的操作或者扩展Nmap的功能
>
> 默认提供了丰富的脚本库，目前已经包含14个类别的350多个脚本
>
> 网络发现
>
> 更加复杂的版本侦测
>
> 漏洞侦测
>
> 后门侦测
>
> 漏洞利用

> NSE默认脚本用法
>
> -sC/--script=default 使用默认类别的脚本进行扫描

